# Сопоставление данных (Sopostavlenie)

Программа для автоматического сопоставления данных из Excel-файлов с использованием алгоритмов нечеткого поиска и семантического анализа.

## Обзор

Проект предназначен для автоматизации процесса сопоставления записей между двумя источниками данных. Поддерживает два основных сценария работы:
- **Простое сопоставление** - сравнение двух столбцов (лайт-версия)
- **Сопоставление смет с этапами** - работа с многолистовыми файлами, учет этапов и разделов работ (макси-версия)

## Основные возможности

- **Двухэтапное сопоставление:**
  - Fuzzy matching - нечеткое сравнение строк по алгоритму token_sort_ratio
  - Embeddings refinement - семантическое сравнение для не найденных вариантов

- **Работа с дубликатами:** автоматическая обработка дубликатов добавлением индексов (_1, _2 и т.д.)

- **Гибкие настройки:** настраиваемые пороги сходства для разных типов данных

- **Поддержка многолистовых файлов:** возможность работы с несколькими листами в одном Excel-файле

- **Удобный интерфейс:** простой графический интерфейс на tkinter

## Версии программы

### Лайт-версия (`main.py`)
**Назначение:** Простое сопоставление двух столбцов данных

**Возможности:**
- Базовый функционал сопоставления
- Работа с одним листом Excel
- Простая настройка порогов
- Идеально для быстрых задач сравнения списков

### Макси-версия (`Submain.py`)
**Назначение:** Сопоставление смет с учетом этапов и разделов работ

**Возможности:**
- Расширенный функционал
- Поддержка многолистовых файлов со сметами
- Индивидуальные пороги для разных типов данных
- Фильтрация по этапам и разделам работ
- Прогресс-бар и детальное логирование
- Возможность отключения отдельных этапов сопоставления
- Режим работы с дубликатами (одинаковый N для повторяющихся комбинаций)

### Утилита дубликатов (`2.py`)
**Назначение:** Предварительная обработка файлов с дубликатами

**Возможности:**
- Обработка дубликатов в существующих Excel-файлах
- Добавление индексов к дубликатам в каждом столбце
- Сохранение оригинальной структуры файла

## Системные требования

- Python 3.7+
- Операционная система Windows/Linux/macOS
- Минимум 4 ГБ оперативной памяти для работы с embeddings

## Установка

### Из исходного кода:

1. Склонируйте репозиторий:
```bash
git clone <repository-url>
cd Sopostavlenie
```

2. Установите зависимости:
```bash
pip install pandas rapidfuzz sentence-transformers torch openpyxl
```

### Использование готовых исполняемых файлов:

Скачайте исполняемые файлы из папки `dist/`:
- `сопоставляшка лайт.exe` - лайт-версия
- `сопоставляшка макси.exe` - макси-версия

## Использование

### Сценарий 1: Простое сопоставление (лайт-версия)

**Когда использовать:** Нужно сопоставить два простых списка без привязки к этапам/разделам.

#### Подготовка Excel-файла:

1. **Структура файла:**
   - Один лист Excel
   - Первые две колонки используются для сопоставления
   - Первая строка - заголовки колонок

2. **Пример правильной структуры:**

| Наименование из прайса | Наименование из сметы |
|------------------------|----------------------|
| Грунтовка глубокого проникновения | Грунтовка для стен |
| Краска акриловая белая | Краска водоэмульсионная |
| Шпатлевка финишная | Шпаклевка белая |

#### Запуск:

1. Запустите `main.py` или `сопоставляшка лайт.exe`
2. Выберите Excel-файл с данными
3. Настройте пороги сходства:
   - **Fuzzy threshold** (65-90): рекомендуется 71-75 для текстовых данных
   - **Embeddings threshold** (0.5-0.9): рекомендуется 0.7 для дополнительной проверки
4. Нажмите "Запустить"
5. Результаты будут сохранены в `output_matches.xlsx`

#### Результат:

Файл содержит колонки:
- Исходный индекс
- Первый столбец (A) - с обработанными дубликатами
- Второй столбец (B) - с обработанными дубликатами
- Кандидат из fuzzy
- Fuzzy сходство (%)
- Кандидат из векторов
- Сходство векторов (%)
- Вердикт (Сопоставлено/Несопоставлено)

---

### Сценарий 2: Сопоставление смет с этапами (макси-версия)

**Когда использовать:** Работа со сметами, где важно учитывать этапы строительства и разделы работ.

#### Подготовка Excel-файла:

1. **Структура файла:**
   - Многолистовой Excel-файл (.xlsx)
   - **Лист "0"** - главная смета (эталонная база)
   - **Листы "1", "2", "3"...** или с произвольными названиями - второстепенные сметы для сопоставления

2. **Обязательные колонки на ВСЕХ листах:**
   - **N** - идентификационный номер записи (текст или число)
   - **Наименование работ** - описание работы/материала
   - **Этап** - этап строительства (например: "Подготовительные работы", "Фасадные работы")
   - **Раздел работ** - раздел/категория (например: "Штукатурные работы", "Малярные работы")

3. **ВАЖНО:** 
   - Названия колонок должны быть ТОЧНО такими: "N", "Наименование работ", "Этап", "Раздел работ"
   - Регистр имеет значение!
   - Первая строка - заголовки
   - Все колонки обязательны на каждом листе

#### Пример правильной структуры:

**Лист "0" (главная смета):**

| N | Наименование работ | Этап | Раздел работ |
|---|-------------------|------|--------------|
| 1.01 | Грунтовка бетонных стен | Подготовительные работы | Грунтовочные работы |
| 1.02 | Грунтовка кирпичных стен | Подготовительные работы | Грунтовочные работы |
| 2.01 | Штукатурка по бетону | Фасадные работы | Штукатурные работы |
| 2.02 | Штукатурка по кирпичу | Фасадные работы | Штукатурные работы |

**Лист "1" (вторая смета для сопоставления):**

| N | Наименование работ | Этап | Раздел работ |
|---|-------------------|------|--------------|
|  | Грунтование стен из бетона | Подготовительные работы | Грунтовочные работы |
|  | Оштукатуривание бетонного основания | Фасадные работы | Штукатурные работы |

**Примечание:** Колонка N во второстепенных листах может быть пустой - программа заполнит её автоматически на основе сопоставления.

#### Как работает сопоставление:

1. **Первый уровень фильтрации:** Программа ищет записи с совпадающими "Этап" И "Раздел работ"
2. **Второй уровень:** Среди отфильтрованных записей ищет наиболее похожее "Наименование работ"
3. **Результат:** Присваивает найденный номер N из главной сметы

**Пример работы:**
```
Ищем: "Грунтование стен из бетона" 
       Этап: "Подготовительные работы"
       Раздел: "Грунтовочные работы"

Шаг 1: Фильтруем главную смету по Этапу + Разделу
       → Остаются записи 1.01 и 1.02

Шаг 2: Сравниваем "Грунтование стен из бетона" с:
       - "Грунтовка бетонных стен" (сходство: 85%)
       - "Грунтовка кирпичных стен" (сходство: 72%)

Результат: Присваиваем N = 1.01
```

#### Запуск:

1. Запустите `Submain.py` или `сопоставляшка макси.exe`
2. Выберите Excel-файл (многолистовой)
3. Настройте параметры:

   **Пороги для Наименования работ:**
   - Fuzzy threshold (65-90): рекомендуется 65-75
   - Embeddings threshold (0.5-0.9): рекомендуется 0.7

   **Пороги для Этап/Раздел работ (более строгие!):**
   - Fuzzy threshold (80-95): рекомендуется 80-85
   - Embeddings threshold (0.8-0.95): рекомендуется 0.8-0.85

4. **Дополнительные настройки:**
   - ☑ **Использовать Fuzzy matching** - базовый метод (рекомендуется включить)
   - ☑ **Использовать эмбеддинги** - дополнительный метод для сложных случаев (рекомендуется включить)
   - ☐ **Разрешить одинаковый N для дубликатов** - использовать только если в смете есть полностью одинаковые записи (Наименование + Этап + Раздел), которым нужно присвоить один и тот же N

5. Нажмите "Запустить"
6. Следите за прогрессом в окне логирования

#### Результат:

Файл `output_updated.xlsx` с несколькими листами:
- **Лист "0"** - главная смета (без изменений)
- **Листы "1", "2"...** - второстепенные сметы с заполненными:
  - **N** - присвоенный номер из главной сметы
  - **Тип сопоставления** - метод и процент совпадения (например: "Fuzzy: 87%" или "Embeddings: 0.85")

#### Возможные значения в "Тип сопоставления":
- `Fuzzy: 87%` - найдено методом нечеткого поиска с 87% сходством
- `Embeddings: 85.3%` - найдено методом семантического анализа
- `Не найдено` - соответствие не найдено (проверьте правильность этапа/раздела)

---

## Общие требования к входным файлам

### Формат файлов:
- **Формат:** Excel (.xlsx) - обязательно!
- **Кодировка:** UTF-8 (для корректной работы с кириллицей)
- **Размер:** рекомендуется не более 100 МБ
- **Структура:** без объединенных ячеек

### Подготовка данных:

**Обязательно перед запуском:**
1. Закройте Excel-файл (программа не может работать с открытым файлом)
2. Удалите пустые строки между данными
3. Убедитесь, что первая строка содержит заголовки
4. Проверьте отсутствие объединенных ячеек

**Рекомендуется:**
1. Запустите `2.py` для обработки дубликатов (если есть повторяющиеся записи)
2. Удалите лишние пробелы в ячейках
3. Проверьте однородность данных (текст - в текстовом формате, числа - в числовом)

### Предотвращение ошибок:

**❌ Частые ошибки:**

1. **"Файл не найден" или "Нет доступа к файлу"**
   - ✅ Закройте файл в Excel/Google Sheets
   - ✅ Проверьте права доступа
   - ✅ Избегайте спецсимволов в пути к файлу

2. **"Отсутствуют столбцы"** (для макси-версии)
   - ✅ Проверьте ТОЧНОЕ написание колонок: "N", "Наименование работ", "Этап", "Раздел работ"
   - ✅ Убедитесь, что эти колонки есть НА ВСЕХ листах
   - ✅ Проверьте регистр (заглавные/строчные буквы)

3. **"Лист '0' не найден"** (для макси-версии)
   - ✅ Переименуйте главный лист в "0" (ноль, не буква O)

4. **Некорректные результаты сопоставления**
   - ✅ Проверьте правильность этапов и разделов (для макси-версии)
   - ✅ Уменьшите пороги сходства
   - ✅ Включите оба метода (Fuzzy + Embeddings)
   - ✅ Обработайте дубликаты утилитой `2.py`

5. **Ошибки памяти**
   - ✅ Разделите файл на части (< 50,000 строк)
   - ✅ Закройте другие программы

### Контрольный список перед запуском:

#### Для лайт-версии:
- [ ] Файл .xlsx закрыт
- [ ] Есть два столбца для сопоставления
- [ ] Первая строка - заголовки
- [ ] Нет пустых строк между данными

#### Для макси-версии:
- [ ] Файл .xlsx закрыт
- [ ] Главный лист назван "0"
- [ ] На ВСЕХ листах есть колонки: "N", "Наименование работ", "Этап", "Раздел работ"
- [ ] Первая строка на каждом листе - заголовки
- [ ] Нет объединенных ячеек
- [ ] Этапы и разделы заполнены корректно

---

## Настройка параметров

### Fuzzy Threshold (порог нечеткого поиска):
- **Диапазон:** 65-90
- **Как работает:** Чем выше значение, тем более похожими должны быть строки
- **Рекомендации:**
  - 65-70: для очень разных формулировок
  - 71-75: универсальное значение
  - 76-85: для похожих формулировок
  - 86-90: только для почти идентичных строк

### Embeddings Threshold (порог семантического анализа):
- **Диапазон:** 0.5-0.9
- **Как работает:** Оценивает смысловую близость (понимает синонимы)
- **Рекомендации:**
  - 0.5-0.6: очень мягкие критерии
  - 0.7: универсальное значение
  - 0.8-0.85: строгие критерии для Этап/Раздел
  - 0.86-0.9: очень строгие критерии

### Пороги для Этап/Раздел (макси-версия):
**ВАЖНО:** Должны быть выше, чем для наименования работ!
- Fuzzy: рекомендуется 80-85
- Embeddings: рекомендуется 0.8-0.85

**Причина:** Этап и раздел - это категории, которые должны совпадать точно, иначе может быть присвоен неправильный номер работы.

---

## Структура проекта

```
Sopostavlenie/
├── main.py              # Лайт-версия (простое сопоставление)
├── Submain.py           # Макси-версия (сметы с этапами)
├── 2.py                 # Утилита обработки дубликатов
├── build/               # Временные файлы сборки
├── dist/                # Скомпилированные исполняемые файлы
├── *.spec              # Конфигурации PyInstaller
├── input.xlsx          # Пример входного файла
├── output_*.xlsx       # Файлы с результатами
└── README.md           # Этот файл
```

## Алгоритм работы

### Лайт-версия:
1. Загрузка двух столбцов из Excel
2. Обработка дубликатов (добавление _1, _2...)
3. Fuzzy matching - сравнение строк
4. Embeddings refinement - семантический анализ для несопоставленных
5. Сохранение результатов

### Макси-версия:
1. Загрузка главного листа "0" (эталон)
2. Для каждого второстепенного листа:
   - Чтение записи (Наименование + Этап + Раздел)
   - Фильтрация главного листа по Этапу И Разделу
   - Поиск наиболее похожего Наименования работ
   - Присвоение номера N
3. Создание нового файла с результатами

## Сборка исполняемых файлов

Для создания standalone-исполняемых файлов:

```bash
# Лайт-версия
pyinstaller --onefile --name "сопоставляшка лайт" main.py

# Макси-версия
pyinstaller --onefile --name "сопоставляшка макси" Submain.py

# Утилита дубликатов
pyinstaller --onefile --name "обработка дубликатов" 2.py
```

## Зависимости

- **pandas** - обработка данных и работа с Excel
- **rapidfuzz** - нечеткое сопоставление строк
- **sentence-transformers** - семантическое кодирование текста
- **torch** - машинное обучение и векторные вычисления
- **tkinter** - графический интерфейс (встроен в Python)
- **openpyxl** - работа с Excel-файлами

## Примеры использования

### Пример 1: Сопоставление прайс-листов (лайт-версия)

**Входной файл:**
| Наименование поставщика | Наименование в каталоге |
|------------------------|-------------------------|
| Грунт. глуб. проникн. 10л | Грунтовка глубокого проникновения |
| Краска акрил. бел. 14кг | Краска водоэмульсионная белая |

**Результат:** Программа найдет соответствия даже при разных сокращениях.

### Пример 2: Сопоставление смет разных подрядчиков (макси-версия)

**Главная смета (лист "0"):**
| N | Наименование работ | Этап | Раздел работ |
|---|-------------------|------|--------------|
| 5.1.1 | Устройство стяжки цементно-песчаной М150 толщиной 50мм | Внутренние работы | Полы |
| 5.1.2 | Устройство гидроизоляции обмазочной | Внутренние работы | Полы |

**Смета подрядчика (лист "1"):**
| N | Наименование работ | Этап | Раздел работ |
|---|-------------------|------|--------------|
|  | Стяжка цем-песч М150 h=50мм | Внутренние работы | Полы |
|  | Обмазочная гидроизоляция | Внутренние работы | Полы |

**После обработки (лист "1"):**
| N | Наименование работ | Этап | Раздел работ | Тип сопоставления |
|---|-------------------|------|--------------|-------------------|
| 5.1.1 | Стяжка цем-песч М150 h=50мм | Внутренние работы | Полы | Fuzzy: 78% |
| 5.1.2 | Обмазочная гидроизоляция | Внутренние работы | Полы | Fuzzy: 82% |

## Часто задаваемые вопросы (FAQ)

**Q: Почему программа не находит очевидные совпадения?**
A: Снизьте пороги сходства. Начните с Fuzzy: 65, Embeddings: 0.7

**Q: Можно ли сопоставить больше двух столбцов?**
A: Лайт-версия работает только с двумя столбцами. Для более сложной логики используйте макси-версию.

**Q: Что делать если этапы/разделы называются по-разному в разных сметах?**
A: Приведите названия к единому виду вручную перед обработкой, либо снизьте пороги для Этап/Раздел (но это может привести к ошибкам).

**Q: Программа слишком долго работает**
A: Отключите embeddings или разделите файл на несколько частей.

**Q: Зачем нужна утилита дубликатов?**
A: Она подготавливает файл к обработке, добавляя уникальные индексы к повторяющимся записям.

**Q: Что такое "Разрешить одинаковый N для дубликатов"?**
A: Режим для случаев, когда в смете есть абсолютно одинаковые записи (повторяются несколько раз), которым нужно присвоить один N из главной сметы.

## Поддержка

При возникновении вопросов или проблем создайте issue в репозитории с описанием:
- Версия программы
- Структура входного файла (скриншот или пример)
- Текст ошибки (если есть)
- Ожидаемый и фактический результат

